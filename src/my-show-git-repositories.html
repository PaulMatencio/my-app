<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="icon-toggle.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-show-git-shared-styles.html">
<link rel="import" href="my-paper-icon-button-custom-styles.html">

<dom-module id="my-show-git-repositories">
    <template>
      <!-- Styles MUST be inside template -->
      <style include="shared-styles"></style>
      <style include="my-show-git-shared-styles"></style>

      <style>

        :host {
            display: block;
            padding : 0;
            line-height: 1.5;
            background-color: var(--host-background-color, #efefef);
        }

        .card {
          @apply --my-card;
          background-color: var(--paper-indigo-50);
        }

        .hidden {
          display: none;
        }

        .name {
          @apply --my-important;
          display: inline-flex;
          margin-bottom: 10px;
        }

        .language {
            @apply --my-important;
            color: var(--paper-blue-900);
        }

        .title {
          @apply --my-title;
          background-color: var(--paper-indigo-50);
          color: var(--paper-blue-600);
        }

        div > .title {
          margin: 0;
        }

        a {
          display: block;
        }

        div  a {
          display: inline-flex;
        }

        @media (max-width: 640px ) {
          .card {
            height: auto;
            width: auto;
           /*  background-color: white; */
          }
          .card:hover {
              /* background-color: var(--paper-indigo-50); */
              -webkit-transform: scale(1.1);
              transform: scale(1.1);
          }
        }

        @media (min-width: 641px ) and (max-width: 1024px) {
          .card {
            width: 40%;
          }
        }
      </style>

      <!-- import classes in an element -->
      <style include="iron-flex iron-flex-alignment"></style>

      <!--  include custom style   -->
      <custome-style>
        <style include="my-paper-icon-button-custom-styles"></style>
      </custom-style>

      <div class= "layout horizontal center-center title">
            <div class="title"> <span> Show Github repositories</span> </div>
            <div> <span> #[[numberRepos]] </span></div>
      </div>
      <div class="layout horizontal center-center input">
          <iron-input  id="user" bind-value="{{user}}">
            <input type="text" value="{{user::input}}">
          </iron-input>
           <paper-icon-button icon="search" title="Search on Github" class="light-blue"  on-click="_fire"></paper-icon-button>
          <!--iron-icon class="icon" icon="search" on-click="_fire" ></iron-icon-->

          <iron-input  id="filter"  bind-value="{{filter}}">
            <input type="text" placeholder= "filter name" value="{{filter::input}}">
          </iron-input>
      </div>

      <!--iron-media-query query="(max-width: 768x)" query-matches="{{wide}}"></iron-media-query>
      <iron-media-query query="(min-width: 769px) and (max-width: 1600px)" query-matches="{{wide1}}"></iron-media-query-->

      <!-- on-response="_handleResponse" -->
      <iron-ajax
            verbose
            id="requestRepos"
            url="[[url]]"
            params='{"type":"all"}'
            handle-as="json"
            on-response="_handleResponse"
            lastError = "{{lastError}}"
            last-response="{{liveData}}"
            on-error = "_handleError"
            iron-ajax-error = "_handleError"
            debounce-duration="300">
      </iron-ajax>

      <app-indexeddb-mirror
        key="repos"
        data="{{liveData}}"
        persisted-data="{{persistedData}}">
      </app-indexeddb-mirror>

      <div class="layout horizontal">
        <div  class="layout horizontal center-center wrap">
          <!--template is="dom-repeat" items="[[repos]]" -->
          <template is="dom-repeat" items="[[persistedData]]"  initial-count="10">
            <div  id="repos" class="card layout-flex">
               <div class="name">
                 [[item.name]]<a href="[[item.html_url]]"> <paper-icon-button icon="link" title="Git url" class="light-blue"></paper-icon-button></a>
                   <dom-if if="[[item.has_pages]]">
                      <template>
                        <div>
                          <a href="[[item.homepage]]"> <paper-icon-button icon="home" title="Home page"  class="light-blue"></paper-icon-button></a>
                        </div>
                      </template>
                   </dom-if>
               </div>
               <div class="description>">
                 <span>[[item.description]]</span>
               </div>
               <div class="language">[[item.language]]</div>
               <div>[[item.created_at]]</div>
             </div>
           </template>
         </div>
       </div>

    </template>

    <script>
    class MyShowGitRepositories extends Polymer.Element {
        static get is()  { return 'my-show-git-repositories' }
        static get properties() {
          return {
            repos: {
              type: Array,
              value: [],
              notify: true,
              reflectToAttribute: true
            },

            user: {
              type: String,
              value: "PaulMatencio",
              notify: true,
              reflectToAttribute: true,
              observer: "_user"
            },

            filter: {
              type: String,
              value: "",
              notify: true,
              reflectToAttribute: true,
              observer: "_filter"
            },

            url: {
              type: String,
              value: function() {
                return ("https://api.github.com/users/" + this.user + "/repos")
              },
              reflectToAttribute: true
            },

            numberRepos: {
              type: Number,
              computed : '_computedLength(repos)',
              reflectToAttribute: true
            }
          }
        }

        constructor() {
          super();
        }

        ready() {
          super.ready();
          /**
           * You can trigger a request explicitly by calling generateRequest on the element.
           */
          this.$.requestRepos.generateRequest();
        }

        _handleResponse(event)  {
            const req = event.detail; // iron-request
            console.log('status', req.status, req.statusText);
            /**
            * iron-ajax does not provide any status != 200 but log them since
            * the option verbose was given
            */
            if (req.status == 200 ) {
              this.repos = event.detail.response;
              console.log(this.repos);
            }
         }

        _handleErrort(request, erorr)  {
          // TO DO when iron-ajax return an error
          console.log(request,error);
        }

        /**  Obsever  of the user input element
          *
         */
        _user() {
            this.url =  "https://api.github.com/users/" + this.user + "/repos";
        }

        /**
          * Obsever  of the filter input element
         */
        _filter() {
            var reposa = this.shadowRoot.querySelectorAll("#repos");
            if (reposa == undefined) {return} ;
            var filter = this.filter.toLowerCase();
            reposa.forEach(function(repos,index)  {
              // We use the array this.repos.name to filter
              name = this.repos[index].name.toLowerCase() ;
              if ( name.indexOf(filter) < 0 ) {
                    repos.classList.add("hidden") ;
              } else {
                repos.classList.remove("hidden") ;
              }
            },this);
         }

         /* Fire the resquest when the search icon is pressed */
        _fire() {
            this.repos = [];
            this.$.requestRepos.generateRequest();
        }

        _click() {
           // for the future
        }

        _computedLength(repos) {
          return repos.length ;
        }
      }

      // Register custom element definition using standard platform API
      customElements.define(MyShowGitRepositories.is, MyShowGitRepositories);
    </script>

</dom-module>
